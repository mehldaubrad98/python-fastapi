options:
  logging: CLOUD_LOGGING_ONLY

steps:
# List files in workspace
- name: 'ubuntu'
  id: 'list-files'
  args: ['ls', '-la']

# Terraform init with backend config
- name: 'hashicorp/terraform:1.0.0'
  id: 'tf-init'
  args: [
    'init',
    '-backend-config=bucket=$PROJECT_ID-terraform-state',
    '-backend-config=prefix=terraform/state'
  ]
  dir: 'terraform'

# Terraform plan
- name: 'hashicorp/terraform:1.0.0'
  id: 'tf-plan'
  args: ['plan']  # Removed -var-file argument
  dir: 'terraform'
  waitFor: ['tf-init']

# Terraform apply
- name: 'hashicorp/terraform:1.0.0'
  id: 'tf-apply'
  args: ['apply', '-auto-approve']  # Removed -var-file argument
  dir: 'terraform'
  waitFor: ['tf-plan']

# Build Docker image
- name: 'gcr.io/cloud-builders/docker'
  id: 'build-image'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/fastapi-app:$COMMIT_SHA', '-f', 'Dockerfile', '.']
  waitFor: ['tf-apply']

# Push Docker image
- name: 'gcr.io/cloud-builders/docker'
  id: 'push-image'
  args: ['push', 'gcr.io/$PROJECT_ID/fastapi-app:$COMMIT_SHA']
  waitFor: ['build-image']

# Deploy to GKE
- name: 'gcr.io/cloud-builders/gke-deploy'
  id: 'deploy-app'
  args:
  - run
  - --filename=kubernetes/
  - --location=${_REGION}
  - --cluster=${_CLUSTER_NAME}
  - --image=gcr.io/$PROJECT_ID/fastapi-app:$COMMIT_SHA
  waitFor: ['push-image']

images:
- 'gcr.io/$PROJECT_ID/fastapi-app:$COMMIT_SHA'

substitutions:
  _REGION: us-central1
  _CLUSTER_NAME: fastapi-gke-cluster

timeout: '3600s'
